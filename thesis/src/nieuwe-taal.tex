\chapter{Configuratie van een programmeertaal in TESTed}\label{ch:nieuwe-taal}

In dit hoofdstuk wordt in detail uitgelegd hoe een nieuwe programmeertaal aan TESTed toegevoegd kan worden.
We doen dat door te beschrijven hoe de programmeertaal C aan TESTed toegevoegd is.
Dit hoofdstuk sluit qua vorm en stijl dan ook dichter aan bij een handleiding.
Enkele nuttige links en verwijzingen hierbij zijn:

\begin{itemize}
    \item Bestaande configuraties: \url{https://github.com/dodona-edu/universal-judge/tree/new-master/judge/src/tested/languages}
    \item Een versie van (een deel van) dit hoofdstuk in Markdown, wat gemakkelijker is in gebruik (voor bijvoorbeeld het kopiÃ«ren van code): \url{https://github.com/dodona-edu/universal-judge/blob/new-master/thesis/src/c-language.md}
    \item \Cref{ch:echo-oefening,ch:echo-function-oefening} bevatten volledige oefeningen: de opgave, het testplan en de gegenereerde code.
    Dat laatste kan nuttig zijn om ook het concrete resultaat te zien van de sjablonen.
\end{itemize}

\section{TESTed lokaal uitvoeren}\label{sec:tested-lokaal-uitvoeren}

Tijdens het configureren van een programmeertaal is het nuttig om TESTed lokaal uit te voeren, zonder daarvoor het volledige Dodona-platform te moeten uitvoeren.
Buiten de \english{dependencies} voor de bestaande programmeertalen is TESTed een Python-package, die op de normale manier uitgevoerd kan worden.

\subsection{De broncode}\label{subsec:de-broncode}

Na het klonen van de repository van TESTed beschikken we over volgende mappenstructuur:

\inputminted{text}{code/tested-dir.txt}

Merk op dat dit de toestand is op het moment van het schrijven van deze tekst.
Het is te voorzien dat in een later stadium alles behalve de mappen \texttt{judge} en \texttt{exercise} verhuizen naar een andere repository.
In dit hoofdstuk interesseren we ons enkel in die mappen, dus we voorzien geen grote problemen.

\subsection{Dependencies}\label{subsec:dependencies}

De dependencies van TESTed zelf zijn opgelijst is een \texttt{requirements.txt}-bestand, zoals gebruikelijk is bij Python-projecten.
Vereisten voor het uitvoeren van tests staan in \texttt{requirements-test.txt}.
TESTed gebruikt Python 3.8 of later.
Het installeren van deze vereisten gebeurt op de gebruikelijke manier:

\begin{minted}{console}
> pip install -r requirements.txt
\end{minted}

Voor de programmeertalen zijn volgende dependencies nodig:

\begin{description}
    \item[Python] Er zijn geen dependencies nodig voor het beoordelen van Python-oplossingen, buiten dat \texttt{python} beschikbaar moet zijn in de \texttt{PATH}.
    \item[Java] TESTed vereist Java 11, maar heeft verder geen dependencies.
                De commando's \texttt{javac} en \texttt{java} moeten beschikbaar zijn in de \texttt{PATH}.
    \item[Haskell] Voor Haskell is \acronym{GHC} 8.6 or later nodig.
    Daarnaast is \texttt{aeson} nodig.
    Beiden moeten globaal beschikbaar zijn in de \texttt{PATH}.
\end{description}

Merk op dat de dependencies voor de programmeertalen optioneel zijn.
Om bijvoorbeeld enkel Python-oplossingen te beoordelen zijn geen andere dependencies nodig.

Voor de programmeertaal C gaan we gebruik maken van \acronym{GCC}, waarbij versie 8.1 of later nodig is.

TESTed werkt op elk besturingssysteem dat ondersteund wordt door Python.
Sommige dependencies, zoals \texttt{gcc}, vragen wel meer moeite om te installeren op Windows.\footnote{Gebruikers op Windows kunnen Min\acronym{GW} of \acronym{MSYS}2 proberen.}

\subsection{Uitvoeren}\label{subsec:uitvoeren}

We gaan er voor de rest van het hoofdstuk vanuit dat commando's uitgevoerd worden in de map \texttt{judge/src}.

Er zijn twee manieren om TESTed uit te voeren.
Ten eerste is er de "gewone" manier;
dit is ook hoe Dodona TESTed uitvoert.
Bij het uitvoeren op deze manier zal TESTed een configuratie lezen van \texttt{stdin} en zal het resultaat van de beoordeling in Dodona-formaat uitgeschreven worden naar \texttt{stdout}.

\begin{minted}{console}
> python -m tested
\end{minted}

Bij het configureren van een programmeertaal of het werken aan TESTed is het echter nuttiger om meer uitvoer te zien en is het vervelend om telkens een configuratie te lezen vanop \texttt{stdin}.
Daarom is er een tweede manier:

\begin{minted}{console}
> python -m tested.manual
\end{minted}

Deze uitvoer verschilt op een aantal vlakken van de gewone uitvoering:

\begin{enumerate}
    \item Er wordt geen configuratie gelezen van \texttt{stdin}.
    De configuratie is gedefinieerd in de code zelf en gebruikt een van de oefeningen die in de map \texttt{exercise} zitten.
    \item Er worden, naast de resultaten van de beoordeling, logs uitgeschreven naar \texttt{stdout} die aangeven wat TESTed doet.
    Als er bijvoorbeeld een fout optreedt tijdens het compileren zullen deze logs nuttig zijn: zo wordt uitgeschreven welk commando TESTed exact uitvoert voor de compilatie en ook in welke map dat gebeurt.
    \item De configuratie is zo opgesteld dat de werkmap van de judge de map \texttt{workdir} zal zijn.
    Dit laat toe om de gegenereerde code te inspecteren.
\end{enumerate}

\section{Algemeen stappenplan voor het configureren van een programmeertaal}\label{sec:algemeen-stappenplan-voor-het-configureren}

Het configureren van een programmeertaal in TESTed bestaat uit drie grote onderdelen:

\begin{enumerate}
    \item Het configuratiebestand, met enkele opties voor de programmeertaal.
    \item De configuratieklasse, met de meer dynamische opties, zoals het compilatiecommando.
    \item De sjablonen, die gebruikt worden om code te genereren.
\end{enumerate}

We overlopen nu elk onderdeel in functie van de programmeertaal C\@.

\section{De programmeertaal C}\label{sec:de-programmeertaal-c}

\markdownInput[shiftHeadings=2]{c-language.md}

\section{Hoe lang duurt het implementeren van een programmeertaal?}\label{sec:hoe-lang-duurt-het-implementeren-van-een-programmeertaal?}

TODO

\section{Stabiliteit van TESTed}\label{sec:stabiliteit-van-tested}

Met stabiliteit wordt hier bedoeld hoe flexibel TESTed is bij het toevoegen van een nieuwe programmeertaal.
Dit is een maat van hoeveel er aan de kern van TESTed gewijzigd moet worden bij het toevoegen van een nieuwe programmeertaal.

We kunnen de interne werking van TESTed in grote lijnen verdelen in drie onderdelen:

\begin{itemize}
    \item De interface naar de oefeningen toe.
    Hieronder vallen vooral het testplan en het serialisatieformaat.
    \item De interface naar de programmeertalen toe.
    Hieronder vallen vooral het configuratiebestand, de configuratieklasse en de verplichte sjablonen.
    \item Het interne deel, waar het testplan uitgevoerd wordt, de ingediende oplossingen beoordeeld worden en de resultaten naar Dodona geschreven worden.
\end{itemize}

De grenzen tussen deze onderdelen zijn niet strikt: zo zal de configuratieklasse ook gebruikt worden in het interne deel tijdens de uitvoering van het testplan.

We willen opmerken dat de focus in deze thesis vooral lag op de interface naar de oefeningen toe (dus het testplan en het serialisatieformaat).
We verwachten dan ook niet dat het toevoegen van een programmeertaal grote onverwachte wijzigingen vereist in het testplan of het serialisatieformaat.
We spreken van onverwachte wijzigingen, omdat sommige delen van TESTed juist voorzien zijn op wijzigingen.
Een voorbeeld zijn de gegevenstypes uit het serialisatieformaat.
Daar is het juist de bedoeling dan nieuwe programmeertalen bijkomende geavanceerde gegevenstypes toevoegen indien nodig.
Als een nieuwe programmeertaal bijvoorbeeld ondersteuning wil bieden voor oneindige generators (bijvoorbeeld een functie die getallen blijft teruggeven, dan is dat mogelijk.
Er zullen ook geen wijzigingen nodig zijn aan de bestaande programmeertalen.

Het omgekeerde is ook waar: we verwachten dat er wijzigingen nodig kunnen zijn aan de configuratieklasse en/of de sjablonen bij nieuwe programmeertalen.
Een stabiele interface tussen de programmeertalen enerzijds en de kern van TESTed anderzijds is geen doel in deze thesis.
Hierbij wel twee nuances:

\begin{itemize}
    \item Hoewel er een poging gedaan is om de configuratieklasse flexibel te maken, is de functionaliteit ervan vooral voorzien op de ondersteunde programmeertalen en de programmeertalen die er op lijken.
    Het is ook op voorhand moeilijk in te schatten welke functionaliteit nodig zal zijn voor nieuwe programmeertalen.
    \item De wijzigingen zullen naar verwachting vooral in de configuratieklasse zijn.
    De methodes om de code te compileren en uit te voeren krijgen momenteel als argumenten de nodige informatie.
    Het is goed mogelijk dat een nieuwe programmeertaal meer informatie nodig zal hebben.
    Een ander aspect waar wijzigingen mogelijk zijn is welke informatie beschikbaar wordt gesteld aan de sjablonen.
    Ook hier is het mogelijk dat een programmeertaal meer informatie nodig heeft dan de informatie die TESTed momenteel aanreikt.
\end{itemize}

De ontwikkeling van TESTed vond grotendeels plaats met drie programmeertalen: Python, Java en Haskell.
C is pas in een later stadium toegevoegd, waar de meeste functionaliteit van TESTed reeds bestond.
Bij het configureren van C zijn wijzigingen nodig geweest aan de configuratieklasse.
Een voorbeeld is dat bij de methode voor het uitvoeren van de code nu ook het volledige pad naar de map waarin het uitvoeren gebeurt een argument is.
C compileert naar een uitvoerbaar bestand, wat tot dan nog niet gebeurde (Haskell gebruikte nog \texttt{runhaskell}).
Om het uitvoerbare bestand uit te voeren is een absoluut pad naar dat uitvoerbaar bestand nodig, maar die informatie was niet voorhanden in de methode.
