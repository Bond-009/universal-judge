$id: "https://github.com/dodona-edu/universal-judge/blob/master/tested/dsl/schema.yaml"
$schema: "http://json-schema.org/draft-07/schema#"
title: "DSL Schema"
description: "YAML DSL TESTed testplan"
type: "array"
minItems: 1
items:
  $ref: "#/definitions/tab"
definitions:
  config:
    type: "object"
    description: "Configuration properties for textual comparison"
    minProperties: 1
    properties:
      applyRounding:
        description: "Apply rounding when comparing as float"
        type: "boolean"
      caseInsensitive:
        description: "Ignore case when comparing strings"
        type: "boolean"
      ignoreWhitespace:
        description: "Ignore leading and trailing whitespace"
        type: "boolean"
      roundTo:
        description: "The number of decimals to round at, when applying the rounding on floats"
        type: "integer"
      tryFloatingPoint:
        description: "Try comparing text as floating point numbers"
        type: "boolean"
  localConfig:
    type: "object"
    description: "Specific configuration properties for textual comparison of one value"
    required:
      - "data"
      - "config"
    properties:
      data:
        $ref: "#/definitions/textualTypes"
      config:
        $ref: "#/definitions/config"
  globalConfig:
    type: "object"
    description: "Global configuration properties for textual comparison"
    minProperties: 1
    properties:
      stdout:
        $ref: "#/definitions/config"
      stderr:
        $ref: "#/definitions/config"
  streamOutput:
    anyOf:
      - $ref: "#/definitions/textualTypes"
      - $ref: "#/definitions/localConfig"
  file:
    type: "object"
    description: "Tab definition with testcases"
    required:
      - "name"
      - "url"
    properties:
      name:
        type: "string"
        description: "File name"
      url:
        type: "string"
        format: "uri"
        description: "Relative path to the file in the `description` folder of a Dodona exercise"
  tab:
    type: "object"
    description: "Tab definition with runs"
    properties:
      config:
        $ref: "#/definitions/globalConfig"
        description: "Configuration of textual comparison at tab level"
      disable_optimizations:
        type: "boolean"
        description: "Disable performance optimizations"
      hidden:
        type: "boolean"
        description: "Defines if the tab is hidden for the student or not"
      tab:
        type: "string"
        description: "Name for the tab on Dodona"
      contexts:
        type: "array"
        description: "Context test sequence"
        items:
          $ref: "#/definitions/context"
    required:
      - "contexts"
      - "tab"
  context:
    type: "object"
    description: "Information to execute one context"
    oneOf:
      - anyOf:
          - required:
              - "testcases"
          - required:
              - "arguments"
          - required:
              - "exception"
          - required:
              - "exit_code"
          - required:
              - "stdin"
          - required:
              - "stderr"
          - required:
              - "stdout"
      - $ref: "#/definitions/testcase"
    properties:
      config:
        $ref: "#/definitions/globalConfig"
        description: "Configuration of textual comparison at context level"
      files:
        type: "array"
        items:
          $ref: "#/definitions/file"
      testcases:
        type: "array"
        description: "Array of statements and expression tests"
        minItems: 1
        items:
          $ref: "#/definitions/testcase"
      arguments:
        type: "array"
        description: "Array of program call arguments"
        items:
          $ref: "#/definitions/textualTypes"
      exception:
        description: "Expected exception for main call"
        $ref: "#/definitions/textualTypes"
      exit_code:
        type: "integer"
        description: "Expected exit code for the run"
      stdin:
        description: "Given input at stdin for main call"
        $ref: "#/definitions/textualTypes"
      stderr:
        description: "Expected output for main call at stderr"
        $ref: "#/definitions/streamOutput"
      stdout:
        description: "Expected output for main call at stdout"
        $ref: "#/definitions/streamOutput"
  testcase:
    type: "object"
    description: "An individual test for a statement or expression"
    properties:
      exception:
        description: "Expected exception message"
        $ref: "#/definitions/textualTypes"
      files:
        type: "array"
        items:
          $ref: "#/definitions/file"
      return:
        description: "Expected return value"
        anyOf:
          - type: "array"
          - type: "boolean"
          - type: "integer"
          - type: "null"
          - type: "number"
          - type: "object"
          - type: "string"
      return-raw:
        description: "Value string to parse to the expected return value"
        $ref: "#/definitions/textualTypes"
      statement:
        description: "Statement or expression to evaluate"
        $ref: "#/definitions/textualTypes"
      expression:
        description: "Statement or expression to evaluate"
        $ref: "#/definitions/textualTypes"
      stderr:
        description: "Expected output at stderr"
        $ref: "#/definitions/streamOutput"
      stdout:
        description: "Expected output at stdout"
        $ref: "#/definitions/streamOutput"
    oneOf:
      - required:
          - "statement"
      - required:
          - "expression"
    dependencies:
      return:
        not:
          required:
            - "return-raw"
      return-raw:
        not:
          required:
            - "return"
      statement:
        not:
          required:
            - "expression"
      expression:
        not:
          required:
            - "statement"
  textualTypes:
    anyOf:
      - type: "boolean"
      - type: "integer"
      - type: "number"
      - type: "string"
